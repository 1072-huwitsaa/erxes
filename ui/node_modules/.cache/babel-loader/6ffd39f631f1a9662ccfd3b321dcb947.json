{"ast":null,"code":"import _objectSpread from \"/home/anu-ujin/Works/open-source/erxes/ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread\";\nimport _defineProperty from \"/home/anu-ujin/Works/open-source/erxes/ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _classCallCheck from \"/home/anu-ujin/Works/open-source/erxes/ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/home/anu-ujin/Works/open-source/erxes/ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/home/anu-ujin/Works/open-source/erxes/ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/home/anu-ujin/Works/open-source/erxes/ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/home/anu-ujin/Works/open-source/erxes/ui/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nvar _jsxFileName = \"/home/anu-ujin/Works/open-source/erxes/ui/src/modules/deals/components/DealEditForm.tsx\";\nimport EditForm from 'modules/boards/components/editForm/EditForm';\nimport Left from 'modules/boards/components/editForm/Left';\nimport Sidebar from 'modules/boards/components/editForm/Sidebar';\nimport Top from 'modules/boards/components/editForm/Top';\nimport { FlexContent, HeaderContentSmall } from 'modules/boards/styles/item';\nimport ControlLabel from 'modules/common/components/form/Label';\nimport ProductSection from 'modules/deals/components/ProductSection';\nimport PortableTasks from 'modules/tasks/components/PortableTasks';\nimport PortableTickets from 'modules/tickets/components/PortableTickets';\nimport React from 'react';\n\nvar DealEditForm =\n/*#__PURE__*/\nfunction (_React$Component) {\n  _inherits(DealEditForm, _React$Component);\n\n  function DealEditForm(props) {\n    var _this;\n\n    _classCallCheck(this, DealEditForm);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(DealEditForm).call(this, props));\n\n    _this.renderAmount = function () {\n      var amount = _this.state.amount;\n\n      if (Object.keys(amount).length === 0) {\n        return null;\n      }\n\n      return React.createElement(HeaderContentSmall, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 60\n        },\n        __self: this\n      }, React.createElement(ControlLabel, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 61\n        },\n        __self: this\n      }, \"Amount\"), Object.keys(amount).map(function (key) {\n        return React.createElement(\"p\", {\n          key: key,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 63\n          },\n          __self: this\n        }, amount[key].toLocaleString(), \" \", key);\n      }));\n    };\n\n    _this.onChangeField = function (name, value) {\n      _this.setState(_defineProperty({}, name, value));\n    };\n\n    _this.saveProductsData = function () {\n      var _this$state = _this.state,\n          productsData = _this$state.productsData,\n          paymentsData = _this$state.paymentsData;\n      var saveItem = _this.props.saveItem;\n      var products = [];\n      var amount = {};\n      var filteredProductsData = [];\n      productsData.forEach(function (data) {\n        // products\n        if (data.product) {\n          if (data.currency) {\n            // calculating item amount\n            if (!amount[data.currency]) {\n              amount[data.currency] = data.amount || 0;\n            } else {\n              amount[data.currency] += data.amount || 0;\n            }\n          } // collecting data for ItemCounter component\n\n\n          products.push(data.product);\n          data.productId = data.product._id;\n          filteredProductsData.push(data);\n        }\n      });\n      Object.keys(paymentsData || {}).forEach(function (key) {\n        var perData = paymentsData[key];\n\n        if (!perData.currency || !perData.amount || perData.amount === 0) {\n          delete paymentsData[key];\n        }\n      });\n\n      _this.setState({\n        productsData: filteredProductsData,\n        products: products,\n        amount: amount,\n        paymentsData: paymentsData\n      }, function () {\n        saveItem({\n          productsData: productsData,\n          paymentsData: paymentsData\n        }, function (updatedItem) {\n          _this.setState({\n            updatedItem: updatedItem\n          });\n        });\n      });\n    };\n\n    _this.beforePopupClose = function (afterPopupClose) {\n      var updatedItem = _this.state.updatedItem;\n      var _this$props = _this.props,\n          onUpdate = _this$props.onUpdate,\n          beforePopupClose = _this$props.beforePopupClose;\n\n      if (beforePopupClose) {\n        beforePopupClose(function () {\n          if (updatedItem && onUpdate) {\n            onUpdate(updatedItem);\n          }\n\n          if (afterPopupClose) {\n            afterPopupClose();\n          }\n        });\n      }\n    };\n\n    _this.renderProductSection = function () {\n      var _this$state2 = _this.state,\n          products = _this$state2.products,\n          productsData = _this$state2.productsData,\n          paymentsData = _this$state2.paymentsData;\n\n      var pDataChange = function pDataChange(pData) {\n        return _this.onChangeField('productsData', pData);\n      };\n\n      var prsChange = function prsChange(prs) {\n        return _this.onChangeField('products', prs);\n      };\n\n      var payDataChange = function payDataChange(payData) {\n        return _this.onChangeField('paymentsData', payData);\n      };\n\n      return React.createElement(ProductSection, {\n        onChangeProductsData: pDataChange,\n        onChangeProducts: prsChange,\n        onChangePaymentsData: payDataChange,\n        productsData: productsData,\n        paymentsData: paymentsData,\n        products: products,\n        saveProductsData: _this.saveProductsData,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 144\n        },\n        __self: this\n      });\n    };\n\n    _this.renderItems = function () {\n      return React.createElement(React.Fragment, null, React.createElement(PortableTickets, {\n        mainType: \"deal\",\n        mainTypeId: _this.props.item._id,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 159\n        },\n        __self: this\n      }), React.createElement(PortableTasks, {\n        mainType: \"deal\",\n        mainTypeId: _this.props.item._id,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 160\n        },\n        __self: this\n      }));\n    };\n\n    _this.renderFormContent = function (_ref) {\n      var saveItem = _ref.saveItem,\n          onChangeStage = _ref.onChangeStage,\n          copy = _ref.copy,\n          remove = _ref.remove;\n      var _this$props2 = _this.props,\n          item = _this$props2.item,\n          options = _this$props2.options,\n          onUpdate = _this$props2.onUpdate,\n          addItem = _this$props2.addItem,\n          sendToBoard = _this$props2.sendToBoard;\n      return React.createElement(React.Fragment, null, React.createElement(Top, {\n        options: options,\n        amount: _this.renderAmount,\n        stageId: item.stageId,\n        item: item,\n        saveItem: saveItem,\n        onChangeStage: onChangeStage,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 175\n        },\n        __self: this\n      }), React.createElement(FlexContent, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 184\n        },\n        __self: this\n      }, React.createElement(Left, {\n        options: options,\n        saveItem: saveItem,\n        copyItem: copy,\n        removeItem: remove,\n        onUpdate: onUpdate,\n        sendToBoard: sendToBoard,\n        item: item,\n        addItem: addItem,\n        onChangeStage: onChangeStage,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 185\n        },\n        __self: this\n      }), React.createElement(Sidebar, {\n        options: options,\n        item: item,\n        sidebar: _this.renderProductSection,\n        saveItem: saveItem,\n        renderItems: _this.renderItems,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 197\n        },\n        __self: this\n      })));\n    };\n\n    var _item = props.item;\n    _this.state = {\n      amount: _item.amount || {},\n      productsData: _item.products ? _item.products.map(function (p) {\n        return _objectSpread({}, p);\n      }) : [],\n      // collecting data for ItemCounter component\n      products: _item.products ? _item.products.map(function (p) {\n        return p.product;\n      }) : [],\n      paymentsData: _item.paymentsData,\n      changePayData: {}\n    };\n    return _this;\n  }\n\n  _createClass(DealEditForm, [{\n    key: \"render\",\n    value: function render() {\n      var extendedProps = _objectSpread({}, this.props, {\n        amount: this.renderAmount,\n        sidebar: this.renderProductSection,\n        formContent: this.renderFormContent,\n        beforePopupClose: this.beforePopupClose\n      });\n\n      return React.createElement(EditForm, Object.assign({}, extendedProps, {\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 218\n        },\n        __self: this\n      }));\n    }\n  }]);\n\n  return DealEditForm;\n}(React.Component);\n\nexport { DealEditForm as default };","map":{"version":3,"sources":["/home/anu-ujin/Works/open-source/erxes/ui/src/modules/deals/components/DealEditForm.tsx"],"names":["EditForm","Left","Sidebar","Top","FlexContent","HeaderContentSmall","ControlLabel","ProductSection","PortableTasks","PortableTickets","React","DealEditForm","props","renderAmount","amount","state","Object","keys","length","map","key","toLocaleString","onChangeField","name","value","setState","saveProductsData","productsData","paymentsData","saveItem","products","filteredProductsData","forEach","data","product","currency","push","productId","_id","perData","updatedItem","beforePopupClose","afterPopupClose","onUpdate","renderProductSection","pDataChange","pData","prsChange","prs","payDataChange","payData","renderItems","item","renderFormContent","onChangeStage","copy","remove","options","addItem","sendToBoard","stageId","p","changePayData","extendedProps","sidebar","formContent","Component"],"mappings":"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","sourcesContent":["import EditForm from 'modules/boards/components/editForm/EditForm';\nimport Left from 'modules/boards/components/editForm/Left';\nimport Sidebar from 'modules/boards/components/editForm/Sidebar';\nimport Top from 'modules/boards/components/editForm/Top';\nimport { FlexContent, HeaderContentSmall } from 'modules/boards/styles/item';\nimport { IEditFormContent, IItem, IOptions } from 'modules/boards/types';\nimport ControlLabel from 'modules/common/components/form/Label';\nimport ProductSection from 'modules/deals/components/ProductSection';\nimport { IProduct } from 'modules/settings/productService/types';\nimport PortableTasks from 'modules/tasks/components/PortableTasks';\nimport PortableTickets from 'modules/tickets/components/PortableTickets';\nimport React from 'react';\nimport { IDeal, IDealParams, IPaymentsData } from '../types';\n\ntype Props = {\n  options: IOptions;\n  item: IDeal;\n  addItem: (doc: IDealParams, callback: () => void) => void;\n  saveItem: (doc: IDealParams, callback?: (item) => void) => void;\n  copyItem: (itemId: string, callback: () => void) => void;\n  onUpdate: (item, prevStageId?: string) => void;\n  removeItem: (itemId: string, callback: () => void) => void;\n  beforePopupClose: (afterPopupClose?: () => void) => void;\n  sendToBoard?: (item: any) => void;\n};\n\ntype State = {\n  amount: any;\n  products: IProduct[];\n  productsData: any;\n  paymentsData: IPaymentsData;\n  changePayData: IPaymentsData;\n  updatedItem?: IItem;\n};\n\nexport default class DealEditForm extends React.Component<Props, State> {\n  constructor(props) {\n    super(props);\n\n    const item = props.item;\n\n    this.state = {\n      amount: item.amount || {},\n      productsData: item.products ? item.products.map(p => ({ ...p })) : [],\n      // collecting data for ItemCounter component\n      products: item.products ? item.products.map(p => p.product) : [],\n      paymentsData: item.paymentsData,\n      changePayData: {}\n    };\n  }\n\n  renderAmount = () => {\n    const { amount } = this.state;\n\n    if (Object.keys(amount).length === 0) {\n      return null;\n    }\n\n    return (\n      <HeaderContentSmall>\n        <ControlLabel>Amount</ControlLabel>\n        {Object.keys(amount).map(key => (\n          <p key={key}>\n            {amount[key].toLocaleString()} {key}\n          </p>\n        ))}\n      </HeaderContentSmall>\n    );\n  };\n\n  onChangeField = <T extends keyof State>(name: T, value: State[T]) => {\n    this.setState({ [name]: value } as Pick<State, keyof State>);\n  };\n\n  saveProductsData = () => {\n    const { productsData, paymentsData } = this.state;\n    const { saveItem } = this.props;\n    const products: IProduct[] = [];\n    const amount: any = {};\n    const filteredProductsData: any = [];\n\n    productsData.forEach(data => {\n      // products\n      if (data.product) {\n        if (data.currency) {\n          // calculating item amount\n          if (!amount[data.currency]) {\n            amount[data.currency] = data.amount || 0;\n          } else {\n            amount[data.currency] += data.amount || 0;\n          }\n        }\n        // collecting data for ItemCounter component\n        products.push(data.product);\n        data.productId = data.product._id;\n        filteredProductsData.push(data);\n      }\n    });\n\n    Object.keys(paymentsData || {}).forEach(key => {\n      const perData = paymentsData[key];\n\n      if (!perData.currency || !perData.amount || perData.amount === 0) {\n        delete paymentsData[key];\n      }\n    });\n\n    this.setState(\n      { productsData: filteredProductsData, products, amount, paymentsData },\n      () => {\n        saveItem({ productsData, paymentsData }, updatedItem => {\n          this.setState({ updatedItem });\n        });\n      }\n    );\n  };\n\n  beforePopupClose = (afterPopupClose?: () => void) => {\n    const { updatedItem } = this.state;\n    const { onUpdate, beforePopupClose } = this.props;\n\n    if (beforePopupClose) {\n      beforePopupClose(() => {\n        if (updatedItem && onUpdate) {\n          onUpdate(updatedItem);\n        }\n\n        if (afterPopupClose) {\n          afterPopupClose();\n        }\n      });\n    }\n  };\n\n  renderProductSection = () => {\n    const { products, productsData, paymentsData } = this.state;\n\n    const pDataChange = pData => this.onChangeField('productsData', pData);\n    const prsChange = prs => this.onChangeField('products', prs);\n    const payDataChange = payData =>\n      this.onChangeField('paymentsData', payData);\n\n    return (\n      <ProductSection\n        onChangeProductsData={pDataChange}\n        onChangeProducts={prsChange}\n        onChangePaymentsData={payDataChange}\n        productsData={productsData}\n        paymentsData={paymentsData}\n        products={products}\n        saveProductsData={this.saveProductsData}\n      />\n    );\n  };\n\n  renderItems = () => {\n    return (\n      <>\n        <PortableTickets mainType=\"deal\" mainTypeId={this.props.item._id} />\n        <PortableTasks mainType=\"deal\" mainTypeId={this.props.item._id} />\n      </>\n    );\n  };\n\n  renderFormContent = ({\n    saveItem,\n    onChangeStage,\n    copy,\n    remove\n  }: IEditFormContent) => {\n    const { item, options, onUpdate, addItem, sendToBoard } = this.props;\n\n    return (\n      <>\n        <Top\n          options={options}\n          amount={this.renderAmount}\n          stageId={item.stageId}\n          item={item}\n          saveItem={saveItem}\n          onChangeStage={onChangeStage}\n        />\n\n        <FlexContent>\n          <Left\n            options={options}\n            saveItem={saveItem}\n            copyItem={copy}\n            removeItem={remove}\n            onUpdate={onUpdate}\n            sendToBoard={sendToBoard}\n            item={item}\n            addItem={addItem}\n            onChangeStage={onChangeStage}\n          />\n\n          <Sidebar\n            options={options}\n            item={item}\n            sidebar={this.renderProductSection}\n            saveItem={saveItem}\n            renderItems={this.renderItems}\n          />\n        </FlexContent>\n      </>\n    );\n  };\n\n  render() {\n    const extendedProps = {\n      ...this.props,\n      amount: this.renderAmount,\n      sidebar: this.renderProductSection,\n      formContent: this.renderFormContent,\n      beforePopupClose: this.beforePopupClose\n    };\n\n    return <EditForm {...extendedProps} />;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}